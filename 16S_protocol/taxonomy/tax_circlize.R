tax_circlize <- function(tax_sum, metadata, topN = 5, groupID = "Group") {
    
    # ??��??ϵ?????밲װ
    p_list = c("ggplot2", "reshape2", "circlize")
    for(p in p_list){
        if (!requireNamespace(p)){install.packages(p)}
        suppressPackageStartupMessages(library(p, character.only = TRUE, quietly = TRUE, warn.conflicts = FALSE))
    }
    
    # ????Ĭ?ϲ???
    # library(amplicon)
    # tax_sum = tax_phylum
    # topN = 5
    # groupID = "Group"
    
    # ????ɸѡ
    idx = rownames(metadata) %in% colnames(tax_sum)
    metadata = metadata[idx,,drop=F]
    tax_sum = tax_sum[, rownames(metadata)]
    
    # ??ȡ??Ʒ????Ϣ,Ĭ??Ϊgroup??ָ??
    sampFile = as.data.frame(metadata[, groupID],row.names = row.names(metadata))
    colnames(sampFile)[1] = "group"
    
    #----?????Ƚ???????#----
    mean_sort = as.data.frame(tax_sum[(order(-rowSums(tax_sum))), ])
    # ɸѡǰN?࣬??????ΪOther???????ò?ͬ????
    other = colSums(mean_sort[topN:dim(mean_sort)[1], ])
    mean_sort = mean_sort[1:(topN - 1), ]
    mean_sort = rbind(mean_sort,other)
    rownames(mean_sort)[topN] = c("Other")
    # ??????��???ݣ??????????ļ?
    merge_tax=mean_sort
    
    #----?????ϲ?????ֵ#----
    
    # ת????Ʒ??????????????ȥ????????��????Ʒ??
    mat_t = t(merge_tax)
    mat_t2 = merge(sampFile, mat_t, by="row.names")
    mat_t2 = mat_t2[,c(-1)]
    
    # ????????ֵ??ת?ã???????????
    mat_mean = aggregate(mat_t2[,-1], by=mat_t2[1], FUN=mean) # mean
    # df = do.call(rbind, mat_mean)[-1,]
    df = t(mat_mean[,-1])
    geno = mat_mean$group
    colnames(df) = mat_mean$group
    
    #----Ĭ?ϲ?????ͼ-??ɫ????#----
    
    # ????ͼƬ?ļ?????????????????С
    pdf(file="circlize.pdf", width=89/25.4, height=89/25.4, pointsize=8)
    # ?Ϸ???ͼ??ͼ??????
    chordDiagram(df)
    # ??ͼ??????д???ļ?
    dev.off()
    
    #----ָ????ɫ??ͼ+ͼ??#----
    # ??ɫ?趨
    library(RColorBrewer)
    grid.col = NULL
    # ????ѧ??ɫ??????12??
    grid.col[rownames(df)] = brewer.pal(dim(df)[1], "Set1")
    # ??????????ɫ
    grid.col[colnames(df)] = brewer.pal(dim(df)[2], "Accent")
    
    png(file="circlize_legend.pdf", width = 480, height = 480, pointsize=12)
    # ?Ϸ???ͼ??ͼ??????
    chordDiagram(df, directional = TRUE,diffHeight = 0.03, grid.col = grid.col, transparency = 0.5)
    # ??????-????ͼ??
    legend("left",pch=20,legend=rownames(df),col=grid.col[rownames(df)],bty="n",cex=1,pt.cex=3,border="black")
    # ??????-????ͼ??
    legend("right",pch=20,legend=colnames(df),col=grid.col[colnames(df)],bty="n",cex=1,pt.cex=3,border="black")
    # ??ͼ??????д???ļ?
    dev.off()
}