---
title: "meta_analysis_with_R"
author: "Biao Dong"
date: "2023-01-16"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
# pkgs <- c("mada", "meta", "metafor", "metasens", "mvmeta", "netmeta",
#           "rmeta", "ellipse")
# install.packages(pkgs, repos="http://cran.at.r-project.org/")
```

# Standard Methods
## 1 Fixed Effect and Random Effects Meta-Analysis
### 1.1 Effect Measures for Continus Outcomes
Variable names in R datasets for meta-analysis of continuous responses

```{r figname, echo=FALSE, fig.cap="variable name", out.width = '100%'}
knitr::include_graphics("image/variable_name.jpg")
```
#### **1.1.1 Mean Difference**
THe estimated mean difference $\hat \mu_k = \hat \mu_{ek} - \hat \mu_{ck}$  
variance estimate : $Var(\hat \mu_k) = \frac {s_{ek}^2}{n_{ek}} + \frac {s_{ck}^2}{n_ck}$
An approximate two-sided (1 - $\alpha$) confidence interval for the mean difference  
is given by $(\hat \mu_{ek} - \hat \mu_{ck}) = Z_{1 - \frac {\alpha}{2}} \sqrt {\frac {s_{ek}^2}{n_{ek}} + \frac {s_{ck}^2}{n_ck}}$

```{r}
# 1. Read in the data
library(meta)
data1 <- read.csv("data/dataset01.csv", as.is=TRUE)
# 2. Calculate mean difference and its standard error for
#    study 1 (Boner 1988) of dataset data1:
MD <- with(data1[1,], Me - Mc)
seMD <- with(data1[1,], sqrt(Se^2/Ne + Sc^2/Nc))
# 3. Print mean difference and limits of 95% confidence
#    interval using round function to show only two digits:
# base R
round(c(MD, MD + c(-1,1) * qnorm(1-(0.05/2)) * seMD), 2)
with(data1[1, ],
     print(metacont(Ne, Me, Se, Nc, Mc, Sc),
           digits=2))
# print(metacont(Ne, Me, Se, Nc, Mc, Sc,
#                data=data1, subset=1), digits=2)
zscore <- MD/seMD
round(c(zscore, 2*pnorm(abs(zscore), lower.tail=FALSE)), 4)
```
#### **1.1.2 Standardised Mean Difference**
In many settings differences in the individual studies
SDM : $\hat g_K = (1 - \frac {3}{4n_k - 9}) \frac {\hat \mu_{ek} - \hat \mu_{ck}}{\sqrt ((n_{ek} - 1)s_{ek}^2 + (n_{ck} -1)s_{ck}^2)/(n_{k} - 2)}$  
variance : $Var(\hat g_k) = \frac {n_k}{n_{ek}\times{n_{ck}}} + \frac {\hat g_k^2}{2(n_k - 3.94)}$  
confidence interval : $\hat g_k \pm Z_{1 - \frac {\alpha}{2}} \sqrt Var(\hat g_k)$

```{r}
# 1. Read in the data:
data2 <- read.csv("data/dataset02.csv")
# 2. As usual, to view an object, type its name:
data2
# 3. Calculate total sample sizes
summary(data2$Ne+data2$Nc)
# 1. Calculate standardised mean difference (SMD) and
#    its standard error (seSMD) for study 1 (Blashki) of
#    dataset data2:
N <- with(data2[1,], Ne + Nc)
SMD <- with(data2[1,],
            (1 - 3/(4 * N - 9)) * (Me - Mc) /
            sqrt(((Ne - 1) * Se^2 + (Nc - 1) * Sc^2)/(N - 2)))
seSMD <- with(data2[1,],
              sqrt(N/(Ne * Nc) + SMD^2/(2 * (N - 3.94))))
# 2. Print standardised mean difference and limits of 95% CI
#    interval using round function to show only two digits:
round(c(SMD, SMD + c(-1,1) * qnorm(1-(0.05/2)) * seSMD), 2)
print(metacont(Ne, Me, Se, Nc, Mc, Sc, sm="SMD",
               data=data2, subset=1), digits=2)
```

